<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Intern - Dashboard</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h2 id="title">Intern</h2>
      <div>
        <img id="avatarImg" src="../uploads/default-avatar.png" class="avatar" alt="avatar" 
             onerror="this.src='../uploads/default-avatar.png'" />
        <span id="userInfo"></span>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="card dashboard">
      <div class="card small">
        <h3>Profile</h3>
        <div id="profileBox"></div>
        <h4>Update Profile</h4>
        <input id="p_name" placeholder="Name" />
        <input id="p_email" placeholder="Email" />
        <input id="p_phone" placeholder="Phone" />
        <textarea id="p_bio" placeholder="Bio"></textarea>
        <input type="file" id="p_avatar" />
        <button id="saveProfile">Save Profile</button>
      </div>

      <div class="card small">
        <h3>Mark Attendance</h3>
        <select id="status">
          <option value="present">Present</option>
          <option value="absent">Absent</option>
          <option value="remote">Remote</option>
          <option value="half-day">Half-day</option>
        </select>
        <input id="note" placeholder="Note (optional)" />
        <button id="markBtn">Mark</button>
      </div>

      <div class="card small" id="usersCard">
        <h3>Team / All Users</h3>
        <button id="refreshUsers">Refresh Users</button>
        <table class="table" id="usersTable">
          <thead><tr><th>Name</th><th>Role</th><th>Phone</th><th>Email</th><th>Action</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="footer">RID Bhart - Coaching & Attendance</div>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  const userId = params.get('userId');
  const name = params.get('name');
  const role = params.get('role');
  const token = localStorage.getItem('token');

  document.getElementById('userInfo').textContent = name + ' (' + role + ')';
  document.getElementById('title').textContent = role + ' Dashboard';
  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('token');
    location.href='/';
  });

  async function api(path, method='GET', data=null, isForm=false){
    const opts = { method, headers: {} };
    if(!isForm && data){
      opts.headers['Content-Type']='application/json';
      opts.body=JSON.stringify(data);
    }
    if(isForm && data){
      opts.body = data; // FormData auto sets headers
    }
    if(token) opts.headers['Authorization'] = 'Bearer ' + token;
    const res = await fetch('/api' + path, opts);
    return res.json();
  }

  async function loadProfile(){
    const r = await api('/profile','GET');
    if(r.user){
      document.getElementById('profileBox').innerHTML =
        '<b>' + r.user.name + '</b><br/>' +
        (r.user.email || '') + '<br/>' +
        (r.user.phone || '') + '<p>' + (r.user.bio || '') + '</p>';
      document.getElementById('p_name').value = r.user.name || '';
      document.getElementById('p_email').value = r.user.email || '';
      document.getElementById('p_phone').value = r.user.phone || '';
      document.getElementById('p_bio').value = r.user.bio || '';
      const avatar = document.getElementById('avatarImg');
      avatar.src = r.user.avatar || '../uploads/default-avatar.png';
      avatar.style.display = 'inline-block';
    }
  }

  document.getElementById('saveProfile').addEventListener('click', async () => {
    const name = document.getElementById('p_name').value.trim();
    const email = document.getElementById('p_email').value.trim();
    const phone = document.getElementById('p_phone').value.trim();
    const bio = document.getElementById('p_bio').value.trim();

    // Update profile fields
    const r = await api('/profile', 'PUT', { name, email, phone, bio });
    if(r.error) return alert(r.error);

    // Upload avatar if selected
    const file = document.getElementById('p_avatar').files[0];
    if(file){
      const fd = new FormData();
      fd.append('avatar', file);
      const up = await api('/upload-avatar', 'POST', fd, true);
      if(up.error) alert(up.error);
    }

    alert('Profile updated');
    loadProfile();
  });

  async function loadAttendance(){
    if(!userId) return;
    const res = await api('/attendance/' + userId);
    const tbody = document.querySelector('#attTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    if(res.entries){
      res.entries.forEach(e => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(e.createdAt).toLocaleString()}</td><td>${e.status}</td><td>${e.note||''}</td>`;
        tbody.appendChild(tr);
      });
    }
  }

  document.getElementById('markBtn').addEventListener('click', async () => {
    const status = document.getElementById('status').value;
    const note = document.getElementById('note').value;
    if(!userId){ alert('missing user id'); return; }
    const res = await api('/attendance','POST',{ userId, status, note });
    if(res.attendance){ alert('Attendance marked'); loadAttendance(); }
    else alert(res.error || 'Error');
  });

  async function loadUsers(){
    const res = await api('/users');
    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML='';
    if(res.users){
      res.users.forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.name}</td><td>${u.role}</td><td>${u.phone||''}</td><td>${u.email||''}</td><td></td>`;
        tbody.appendChild(tr);
      });
    }
  }

  loadProfile();
  loadAttendance();
  loadUsers();
</script>
</body>
</html>
