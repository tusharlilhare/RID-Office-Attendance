<!-- 
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Frontend Developer - Dashboard</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h2 id="title">Frontend Developer</h2>
      <div>
        <img id="avatarImg" src="../uploads/default-avatar.png" class="avatar" alt="avatar" onerror="this.style.display='none'"/>
        <span id="userInfo"></span>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="card dashboard">
      <div class="card small">
        <h3>Profile</h3>
        <div id="profileBox"></div>
        <h4>Update Profile</h4>
        <input id="p_name" placeholder="Name" />
        <input id="p_email" placeholder="Email" />
        <input id="p_phone" placeholder="Phone" />
        <textarea id="p_bio" placeholder="Bio"></textarea>
        <input type="file" id="p_avatar" />
        <button id="saveProfile">Save Profile</button>
      </div>

      <div class="card small">
        <h3>Mark Attendance</h3>
        <select id="status">
          <option value="present">Present</option>
          <option value="absent">Absent</option>
          <option value="remote">Remote</option>
          <option value="half-day">Half-day</option>
        </select>
        <input id="note" placeholder="Note (optional)" />
        <button id="markBtn">Mark</button>
      </div>

      <div class="card small" id="usersCard">
        <h3>Team / All Users</h3>
        <button id="refreshUsers">Refresh Users</button>
        <table class="table" id="usersTable">
          <thead><tr><th>Name</th><th>Role</th><th>Phone</th><th>Email</th><th>Action</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" id="managerCard" style="display:none;">
      <h3>Project Manager - Admin Panel</h3>
      <button id="refreshAllAttend">Refresh All Attendance</button>
      <table class="table" id="allAttTable">
        <thead><tr><th>User</th><th>Date</th><th>Status</th><th>Note</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
      <h4>Create User</h4>
      <input id="m_name" placeholder="name (unique)" />
      <input id="m_email" placeholder="email" />
      <input id="m_phone" placeholder="phone" />
      <input id="m_password" placeholder="password" />
      <select id="m_role">
        <option>Project Manager</option><option>Team Leader</option><option>Frontend Developer</option><option>Backend Developer</option><option>HR Manager</option><option>Intern</option><option>CTO</option><option>COO</option><option>Manager</option><option>Student</option>
      </select>
      <button id="createUserBtn">Create User</button>
    </div>

    <div class="card" id="studentCard" style="display:none;">
      <h3>Coaching Courses (Students)</h3>
      <div id="courses"></div>
    </div>

    <div class="footer">RID Bhart - Coaching & Attendance</div>
  </div>

<script>
    const params = new URLSearchParams(location.search);
    const userId = params.get('userId');
    const name = params.get('name');
    const role = params.get('role');
    const token = localStorage.getItem('token');
    document.getElementById('userInfo').textContent = name + ' ('+ role +')';
    document.getElementById('title').textContent = role + ' Dashboard';
    document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('token'); location.href='/'; });

    async function api(path, method='GET', data=null, isForm=false){
      const opts = { method, headers: {} };
      if(!isForm && data){ opts.headers['Content-Type']='application/json'; opts.body=JSON.stringify(data); }
      if(data && isForm) opts.body = data;
      if(token) opts.headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch('/api' + path, opts);
      return res.json();
    }

    async function loadProfile(){
      const r = await api('/profile','GET');
      if(r.user){
        document.getElementById('profileBox').innerHTML = '<b>'+r.user.name+'</b><br/>' + (r.user.email||'') + '<br/>' + (r.user.phone||'') + '<p>'+ (r.user.bio||'') +'</p>';
        document.getElementById('p_name').value = r.user.name || '';
        document.getElementById('p_email').value = r.user.email || '';
        document.getElementById('p_phone').value = r.user.phone || '';
        document.getElementById('p_bio').value = r.user.bio || '';
        if(r.user.avatar) { document.getElementById('avatarImg').src = r.user.avatar; document.getElementById('avatarImg').style.display='inline-block'; }
      }
    }

    document.getElementById('saveProfile').addEventListener('click', async ()=>{
      const name = document.getElementById('p_name').value.trim();
      const email = document.getElementById('p_email').value.trim();
      const phone = document.getElementById('p_phone').value.trim();
      const bio = document.getElementById('p_bio').value.trim();
      const r = await api('/profile','PUT',{ name, email, phone, bio });
      if(r.error) return alert(r.error);
      const file = document.getElementById('p_avatar').files[0];
      if(file){
        const fd = new FormData();
        fd.append('avatar', file);
        const up = await api('/upload-avatar','POST', fd, null, true);
        if(up.error) alert(up.error); else alert('Profile updated');
      } else {
        alert('Profile updated');
      }
      loadProfile();
    });

    async function loadAttendance(){
      if(!userId) return;
      const res = await api('/attendance/'+userId);
      const tbody = document.querySelector('#attTable tbody');
      if(!tbody) return;
      tbody.innerHTML='';
      if(res.entries){
        res.entries.forEach(e=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${new Date(e.createdAt).toLocaleString()}</td><td>${e.status}</td><td>${e.note||''}</td>`;
          tbody.appendChild(tr);
        });
      }
    }

    document.getElementById('markBtn').addEventListener('click', async ()=>{
      const status = document.getElementById('status').value;
      const note = document.getElementById('note').value;
      if(!userId){ alert('missing user id'); return; }
      const res = await api('/attendance','POST',{ userId, status, note });
      if(res.attendance){ alert('Attendance marked'); loadAttendance(); }
      else alert(res.error || 'Error');
    });

    async function loadUsers(){
      const res = await api('/users');
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML='';
      if(res.users){
        res.users.forEach(u=>{
          const tr = document.createElement('tr');
          let action = '';
          if(role === 'Project Manager') action = `<button data-id="${u._id}" class="delUser">Delete</button>`;
          tr.innerHTML = `<td>${u.name}</td><td>${u.role}</td><td>${u.phone||''}</td><td>${u.email||''}</td><td>${action}</td>`;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('.delUser').forEach(b=> b.addEventListener('click', async (ev)=>{
          const id = ev.target.dataset.id;
          if(!confirm('Delete user and their attendance?')) return;
          const r = await api('/users/'+id,'DELETE');
          alert(r.error || 'Deleted');
          loadUsers();
        }));
      }
    }

    async function loadAllAttendance(){
      const res = await api('/all-attendance');
      const tbody = document.querySelector('#allAttTable tbody');
      tbody.innerHTML='';
      if(res.entries){
        res.entries.forEach(e=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${e.user ? e.user.name : '—'}</td><td>${new Date(e.createdAt).toLocaleString()}</td><td>${e.status}</td><td>${e.note||''}</td><td><button data-id="${e._id}" class="delAtt">Delete</button></td>`;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('.delAtt').forEach(b=> b.addEventListener('click', async (ev)=>{
          const id = ev.target.dataset.id;
          if(!confirm('Delete attendance?')) return;
          const r = await api('/attendance/'+id,'DELETE');
          alert(r.error || 'Deleted');
          loadAllAttendance();
        }));
      }
    }

    document.getElementById('refreshUsers').addEventListener('click', loadUsers);
    document.getElementById('refreshAllAttend')?.addEventListener('click', loadAllAttendance);

    document.getElementById('createUserBtn')?.addEventListener('click', async ()=>{
      const name = document.getElementById('m_name').value.trim();
      const email = document.getElementById('m_email').value.trim();
      const phone = document.getElementById('m_phone').value.trim();
      const password = document.getElementById('m_password').value.trim();
      const roleSel = document.getElementById('m_role').value;
      if(!name||!password||!roleSel) return alert('fill details');
      const r = await api('/users','POST',{ name, role: roleSel, password, email, phone });
      if(r.error) return alert(r.error);
      alert('User created');
      loadUsers();
    });

    async function loadCourses(){
      const r = await api('/coaching/courses');
      const box = document.getElementById('courses');
      box.innerHTML='';
      if(r.courses){
        r.courses.forEach(c=>{
          const d = document.createElement('div');
          d.innerHTML = '<h4>'+c.title+'</h4><p>'+c.description+'</p>';
          box.appendChild(d);
        });
      }
    }

    loadProfile();
    loadAttendance();
    loadUsers();
    if(role === 'Project Manager') { document.getElementById('managerCard').style.display='block'; loadAllAttendance(); }
    if(role === 'Student') { document.getElementById('studentCard').style.display='block'; loadCourses(); }
</script>
</body>
</html> -->



<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Frontend Developer - Dashboard</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h2 id="title">Frontend Developer</h2>
      <div>
        <img id="avatarImg" src="../uploads/default-avatar.png" class="avatar" alt="avatar" onerror="this.src='../uploads/default-avatar.png';"/>
        <span id="userInfo"></span>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>

  <div class="card dashboard">
      <div class="card small">
        <h3>Profile</h3>
        <div id="profileBox"></div>
        <h4>Update Profile</h4>
        <input id="p_name" placeholder="Name" />
        <input id="p_email" placeholder="Email" />
        <input id="p_phone" placeholder="Phone" />
        <textarea id="p_bio" placeholder="Bio"></textarea>
        <input type="file" id="p_avatar" />
        <button id="saveProfile">Save Profile</button>
      </div>

      <div class="card small">
        <h3>Mark Attendance</h3>
        <select id="status">
          <option value="present">Present</option>
          <option value="absent">Absent</option>
          <option value="remote">Remote</option>
          <option value="half-day">Half-day</option>
        </select>
        <input id="note" placeholder="Note (optional)" />
        <button id="markBtn">Mark</button>
      </div>

      <!-- <div class="card small" id="usersCard">
        <h3>Team / All Users</h3>
        <button id="refreshUsers">Refresh Users</button>
        <table class="table" id="usersTable">
          <thead><tr><th>Name</th><th>Role</th><th>Phone</th><th>Email</th><th>Action</th></tr></thead>
          <tbody></tbody>
        </table>
      </div> -->
    </div>



    <div class="footer">RID Bhart - Coaching & Attendance</div>
  </div>

<script>
const params = new URLSearchParams(location.search);
const userId = params.get('userId');
const name = params.get('name');
const role = params.get('role');
const token = localStorage.getItem('token');

document.getElementById('userInfo').textContent = name + ' ('+ role +')';
document.getElementById('title').textContent = role + ' Dashboard';
document.getElementById('logoutBtn').addEventListener('click', ()=>{ 
    localStorage.removeItem('token'); 
    location.href='/'; 
});

async function api(path, method='GET', data=null, isForm=false){
    const opts = { method, headers: {} };
    if(!isForm && data){ opts.headers['Content-Type']='application/json'; opts.body=JSON.stringify(data); }
    if(data && isForm) opts.body = data;
    if(token) opts.headers['Authorization'] = 'Bearer ' + token;
    const res = await fetch('/api' + path, opts);
    return res.json();
}

async function loadProfile(){
    const r = await api('/profile','GET');
    if(r.user){
        document.getElementById('profileBox').innerHTML = 
            '<b>'+r.user.name+'</b><br/>' + 
            (r.user.email||'') + '<br/>' + 
            (r.user.phone||'') + 
            '<p>'+ (r.user.bio||'') +'</p>';

        document.getElementById('p_name').value = r.user.name || '';
        document.getElementById('p_email').value = r.user.email || '';
        document.getElementById('p_phone').value = r.user.phone || '';
        document.getElementById('p_bio').value = r.user.bio || '';

        const avatarImg = document.getElementById('avatarImg');
        avatarImg.src = r.user.avatar || '../uploads/default-avatar.png';
        avatarImg.style.display = 'inline-block';
    }
}

document.getElementById('saveProfile').addEventListener('click', async ()=>{
    const name = document.getElementById('p_name').value.trim();
    const email = document.getElementById('p_email').value.trim();
    const phone = document.getElementById('p_phone').value.trim();
    const bio = document.getElementById('p_bio').value.trim();

    const r = await api('/profile','PUT',{ name, email, phone, bio });
    if(r.error) return alert(r.error);

    const file = document.getElementById('p_avatar').files[0];
    if(file){
        const fd = new FormData();
        fd.append('avatar', file);
        const up = await api('/upload-avatar','POST', fd, true);
        if(up.error) alert(up.error);
        else alert('Profile updated with avatar');
    } else {
        alert('Profile updated');
    }
    loadProfile();
});

async function loadAttendance(){
    if(!userId) return;
    const res = await api('/attendance/'+userId);
    const tbody = document.querySelector('#attTable tbody');
    if(!tbody) return;
    tbody.innerHTML='';
    if(res.entries){
        res.entries.forEach(e=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${new Date(e.createdAt).toLocaleString()}</td><td>${e.status}</td><td>${e.note||''}</td>`;
            tbody.appendChild(tr);
        });
    }
}

document.getElementById('markBtn').addEventListener('click', async ()=>{
    const status = document.getElementById('status').value;
    const note = document.getElementById('note').value;
    if(!userId){ alert('missing user id'); return; }
    const res = await api('/attendance','POST',{ userId, status, note });
    if(res.attendance){ alert('Attendance marked'); loadAttendance(); }
    else alert(res.error || 'Error');
});

async function loadUsers(){
    const res = await api('/users');
    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML='';
    if(res.users){
        res.users.forEach(u=>{
            const tr = document.createElement('tr');
            let action = '';
            if(role === 'Project Manager') action = `<button data-id="${u._id}" class="delUser">Delete</button>`;
            tr.innerHTML = `<td>${u.name}</td><td>${u.role}</td><td>${u.phone||''}</td><td>${u.email||''}</td><td>${action}</td>`;
            tbody.appendChild(tr);
        });
        document.querySelectorAll('.delUser').forEach(b=> b.addEventListener('click', async (ev)=>{
            const id = ev.target.dataset.id;
            if(!confirm('Delete user and their attendance?')) return;
            const r = await api('/users/'+id,'DELETE');
            alert(r.error || 'Deleted');
            loadUsers();
        }));
    }
}

async function loadAllAttendance(){
    const res = await api('/all-attendance');
    const tbody = document.querySelector('#allAttTable tbody');
    tbody.innerHTML='';
    if(res.entries){
        res.entries.forEach(e=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${e.user ? e.user.name : '—'}</td><td>${new Date(e.createdAt).toLocaleString()}</td><td>${e.status}</td><td>${e.note||''}</td><td><button data-id="${e._id}" class="delAtt">Delete</button></td>`;
            tbody.appendChild(tr);
        });
        document.querySelectorAll('.delAtt').forEach(b=> b.addEventListener('click', async (ev)=>{
            const id = ev.target.dataset.id;
            if(!confirm('Delete attendance?')) return;
            const r = await api('/attendance/'+id,'DELETE');
            alert(r.error || 'Deleted');
            loadAllAttendance();
        }));
    }
}

document.getElementById('refreshUsers').addEventListener('click', loadUsers);
document.getElementById('refreshAllAttend')?.addEventListener('click', loadAllAttendance);

document.getElementById('createUserBtn')?.addEventListener('click', async ()=>{
    const name = document.getElementById('m_name').value.trim();
    const email = document.getElementById('m_email').value.trim();
    const phone = document.getElementById('m_phone').value.trim();
    const password = document.getElementById('m_password').value.trim();
    const roleSel = document.getElementById('m_role').value;
    if(!name||!password||!roleSel) return alert('fill details');
    const r = await api('/users','POST',{ name, role: roleSel, password, email, phone });
    if(r.error) return alert(r.error);
    alert('User created');
    loadUsers();
});

async function loadCourses(){
    const r = await api('/coaching/courses');
    const box = document.getElementById('courses');
    box.innerHTML='';
    if(r.courses){
        r.courses.forEach(c=>{
            const d = document.createElement('div');
            d.innerHTML = '<h4>'+c.title+'</h4><p>'+c.description+'</p>';
            box.appendChild(d);
        });
    }
}

loadProfile();
loadAttendance();
loadUsers();
if(role === 'Project Manager') { 
    document.getElementById('managerCard').style.display='block'; 
    loadAllAttendance(); 
}
if(role === 'Student') { 
    document.getElementById('studentCard').style.display='block'; 
    loadCourses(); 
}
</script>
</body>
</html>

