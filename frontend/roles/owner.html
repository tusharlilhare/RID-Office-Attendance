<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Owner - Dashboard</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
<div class="container">
  <div class="header">
    <h2 id="title">Owner Dashboard</h2>
    <div>
      <img id="avatarImg" src="../uploads/default-avatar.png" class="avatar" alt="avatar" onerror="this.style.display='none'"/>
      <span id="userInfo"></span>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

  <!-- Profile & Attendance -->
  <div class="card dashboard">
    <div class="card small">
      <h3>Profile</h3>
      <div id="profileBox"></div>
      <h4>Update Profile</h4>
      <input id="p_name" placeholder="Name" />
      <input id="p_email" placeholder="Email" />
      <input id="p_phone" placeholder="Phone" />
      <textarea id="p_bio" placeholder="Bio"></textarea>
      <input type="file" id="p_avatar" />
      <button id="saveProfile">Save Profile</button>
    </div>

    <div class="card small">
      <h3>Mark Attendance</h3>
      <select id="status">
        <option value="present">Present</option>
        <option value="absent">Absent</option>
        <option value="remote">Remote</option>
        <option value="half-day">Half-day</option>
      </select>
      <input id="note" placeholder="Note (optional)" />
      <button id="markBtn">Mark</button>
    </div>
  </div>

  <!-- Owner Panel -->
  <div class="card" id="ownerCard">
    <h3>Owner - Admin Panel</h3>

    <button id="refreshOwnerUsers">Refresh All Users</button>
    <table class="table" id="ownerUsersTable">
      <thead><tr><th>Name</th><th>Role</th><th>Phone</th><th>Email</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>

    <button id="refreshOwnerAttend">Refresh All Attendance</button>
    <table class="table" id="ownerAllAttTable">
      <thead><tr><th>User</th><th>Date</th><th>Status</th><th>Note</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>

    <h4>Create New User</h4>
    <input id="o_name" placeholder="name (unique)" />
    <input id="o_email" placeholder="email" />
    <input id="o_phone" placeholder="phone" />
    <input id="o_password" placeholder="password" />
    <select id="o_role">
      <option>Project Manager</option>
      <option>Team Leader</option>
      <option>Frontend Developer</option>
      <option>Backend Developer</option>
      <option>HR Manager</option>
      <option>Intern</option>
      <option>CTO</option>
      <option>COO</option>
      <option>Manager</option>
      <option>Student</option>
    </select>
    <button id="createOwnerUserBtn">Create User</button>
  </div>

  <div class="footer">RID Bhart - Coaching & Attendance</div>
</div>

<script>
const params = new URLSearchParams(location.search);
const userId = params.get('userId');
const name = params.get('name');
const role = params.get('role');
const token = localStorage.getItem('token');

document.getElementById('userInfo').textContent = name + ' ('+ role +')';
document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('token'); location.href='/'; });

async function api(path, method='GET', data=null, isForm=false){
  const opts = { method, headers: {} };
  if(!isForm && data){ opts.headers['Content-Type']='application/json'; opts.body=JSON.stringify(data); }
  if(data && isForm) opts.body = data;
  if(token) opts.headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch('/api'+path, opts);
  return res.json();
}

// Profile
async function loadProfile(){
  const r = await api('/profile','GET');
  if(r.user){
    document.getElementById('profileBox').innerHTML = `<b>${r.user.name}</b><br/>${r.user.email||''}<br/>${r.user.phone||''}<p>${r.user.bio||''}</p>`;
    document.getElementById('p_name').value = r.user.name || '';
    document.getElementById('p_email').value = r.user.email || '';
    document.getElementById('p_phone').value = r.user.phone || '';
    document.getElementById('p_bio').value = r.user.bio || '';
    if(r.user.avatar) { document.getElementById('avatarImg').src = r.user.avatar; document.getElementById('avatarImg').style.display='inline-block'; }
  }
}

document.getElementById('saveProfile').addEventListener('click', async ()=>{
  const name = document.getElementById('p_name').value.trim();
  const email = document.getElementById('p_email').value.trim();
  const phone = document.getElementById('p_phone').value.trim();
  const bio = document.getElementById('p_bio').value.trim();
  const r = await api('/profile','PUT',{ name, email, phone, bio });
  if(r.error) return alert(r.error);
  const file = document.getElementById('p_avatar').files[0];
  if(file){
    const fd = new FormData();
    fd.append('avatar', file);
    const up = await api('/upload-avatar','POST', fd, null, true);
    if(up.error) alert(up.error); else alert('Profile updated');
  } else alert('Profile updated');
  loadProfile();
});

// Attendance
document.getElementById('markBtn').addEventListener('click', async ()=>{
  const status = document.getElementById('status').value;
  const note = document.getElementById('note').value;
  if(!userId){ alert('missing user id'); return; }
  const res = await api('/attendance','POST',{ userId, status, note });
  if(res.attendance){ alert('Attendance marked'); } else alert(res.error || 'Error');
});

// Users
async function loadUsersTable(){
  const res = await api('/users');
  const tbody = document.querySelector('#ownerUsersTable tbody');
  tbody.innerHTML='';
  if(res.users){
    res.users.forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${u.name}</td><td>${u.role}</td><td>${u.phone||''}</td><td>${u.email||''}</td><td><button data-id="${u._id}" class="delUser">Delete</button></td>`;
      tbody.appendChild(tr);
    });
    document.querySelectorAll('.delUser').forEach(b=>{
      b.addEventListener('click', async ev=>{
        const id = ev.target.dataset.id;
        if(!confirm('Delete user and their attendance?')) return;
        const r = await api('/users/'+id,'DELETE');
        alert(r.error || 'Deleted');
        loadUsersTable();
      });
    });
  }
}

// Attendance Table
async function loadAttendanceTable(){
  const res = await api('/all-attendance');
  const tbody = document.querySelector('#ownerAllAttTable tbody');
  tbody.innerHTML='';
  if(res.entries){
    res.entries.forEach(e=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${e.user ? e.user.name : 'â€”'}</td><td>${new Date(e.createdAt).toLocaleString()}</td><td>${e.status}</td><td>${e.note||''}</td><td><button data-id="${e._id}" class="delAtt">Delete</button></td>`;
      tbody.appendChild(tr);
    });
    document.querySelectorAll('.delAtt').forEach(b=>{
      b.addEventListener('click', async ev=>{
        const id = ev.target.dataset.id;
        if(!confirm('Delete attendance?')) return;
        const r = await api('/attendance/'+id,'DELETE');
        alert(r.error || 'Deleted');
        loadAttendanceTable();
      });
    });
  }
}

// Create User
document.getElementById('createOwnerUserBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('o_name').value.trim();
  const email = document.getElementById('o_email').value.trim();
  const phone = document.getElementById('o_phone').value.trim();
  const password = document.getElementById('o_password').value.trim();
  const roleSel = document.getElementById('o_role').value;
  if(!name||!password||!roleSel) return alert('Fill all details');
  const r = await api('/users','POST',{ name, role: roleSel, password, email, phone });
  if(r.error) return alert(r.error);
  alert('User created');
  loadUsersTable();
});

document.getElementById('refreshOwnerUsers').addEventListener('click', loadUsersTable);
document.getElementById('refreshOwnerAttend').addEventListener('click', loadAttendanceTable);

loadProfile();
loadUsersTable();
loadAttendanceTable();
</script>
</body>
</html>
